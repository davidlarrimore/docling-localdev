# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Docling for macOS (Apple Silicon) is a local deployment wrapper for Docling Serve optimized for Apple Silicon Macs (M1/M2/M3). It provides GPU acceleration via Metal Performance Shaders (MPS) and a simplified setup process.

## Commands

### Initial Setup
```bash
./setup.sh
```
Creates Python 3.12 venv, installs dependencies from requirements.txt, downloads ML model artifacts (~1GB+), and generates the run script.

### Start Docling Serve
```bash
./run-docling-local-apple-silicon.sh
```
Starts Docling Serve on localhost:5001. Web UI at http://localhost:5001/ui

### Reinstall Dependencies
```bash
source venv/bin/activate
pip install -r requirements.txt
```

### Menu Bar App (Optional)
```bash
./macos/DoclingMenuBar/build-app.sh    # Build the app
open build/DoclingMenuBar.app           # Run the app
```
The menu bar app auto-detects the Docling installation, starts Docling on launch, and provides Start/Stop/Restart controls. No terminal windows.

## Architecture

**Key Files:**
- `setup.sh` - Main setup orchestrator; creates venv, installs deps, downloads models, generates run script
- `run-docling-local-apple-silicon.sh` - Generated by setup.sh; starts Docling Serve with Apple Silicon optimizations
- `requirements.txt` - Pinned dependencies (docling~=2.38, docling-serve==1.10.0, torch, mlx, easyocr)
- `macos/DoclingMenuBar/main.swift` - Menu bar app source (single-file Swift app)
- `macos/DoclingMenuBar/build-app.sh` - Build script for .app bundle

**Runtime Directories (git-ignored):**
- `venv/` - Python 3.12 virtual environment
- `artifacts/` - Downloaded ML models (layout detection, OCR, etc.)
- `scratch/` - Temporary working data
- `logs/` - Server logs

## Apple Silicon Environment Variables

Set automatically by the run script:
- `DOCLING_DEVICE=auto` - Auto-detect GPU
- `DOCLING_APPLE_OPTIMIZED=1` - Enable Apple Silicon optimizations
- `PYTORCH_ENABLE_MPS_FALLBACK=1` - Fall back to CPU for unsupported MPS ops
- `DOCLING_NUM_THREADS=8` - Thread count
- `UVICORN_HOST=127.0.0.1`, `UVICORN_PORT=5001` - Server binding

## Coding Conventions

- Bash: Use `set -euo pipefail`, quote variables, uppercase for exported env vars
- Swift: 4-space indentation, `camelCase` for vars, `UpperCamelCase` for types
- Filenames: kebab-case for scripts, UpperCamelCase for app bundles
- Commit messages: short, imperative, capitalized (e.g., "Add feature X")

## Testing

No automated tests. Manual validation: run setup, start server, verify UI loads and accepts documents.
